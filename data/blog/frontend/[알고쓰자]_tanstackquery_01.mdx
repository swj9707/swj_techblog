---
title: '[ì•Œê³ ì“°ì] TanstackQueryì˜ êµ¬ì¡°'
date: '2024-12-09'
lastmod: '2024-12-09'
tags: ['Frontend', 'Study']
draft: false
layout: PostBanner
images: ['/static/images/blog/tanstackquery.png']
summary: ì„œë²„ì‚¬ì´ë“œ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ìì£¼ ì“°ëŠ” TanstackQueryì˜ êµ¬ì¡°ë¥¼ í†ºì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
---

# Intro

í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì„ í•˜ë©° ì—¬ëŸ¬ ìƒíƒœê´€ë¦¬ íˆ´ë“¤ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ì•„ë§ˆ ì •ë§ ë§ì´
ì“°ì‹œëŠ” ê²Œ `Tanstack Query` ì¼ ê²ƒì…ë‹ˆë‹¤.

ìƒíƒœ(State) ë¼ëŠ” ê°œë…ì€ í•´ë‹¹ ê°’ì˜ ë³€í™”ë¡œ ì¸í•´ í”„ë¡ íŠ¸ì—”ë“œì˜ ì»´í¬ë„ŒíŠ¸ì—
ë³€í™”ë¥¼ ì¤„ ìˆ˜ ìˆëŠ” ë°ì´í„°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ ë°ì´í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì˜
ë°ì´í„°ê°€ ë  ìˆ˜ë„ ìˆê³  ì„œë²„ì‚¬ì´ë“œì˜ ë°ì´í„°ê°€ ë  ìˆ˜ë„ ìˆì£ .
`Tanstack Query` ëŠ” ì„œë²„ì‚¬ì´ë“œì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

ì„œë²„ì‚¬ì´ë“œì˜ ìƒíƒœë¼ëŠ” ê°œë…ì„ ì¢€ ì‰½ê²Œ ì •ë¦¬í•´ë³´ë©´, ì„œë²„ì—ì„œ íŒ¨ì¹­ í•´ì„œ ë°›ì•„
ì˜¨ ë°ì´í„°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì„œë²„ì—ê²Œ HTTP ìš”ì²­ì„ ë³´ë‚´ì„œ ë°›ì€ ë°ì´í„°ë¥¼
ì»´í¬ë„ŒíŠ¸ë¥¼ ëœë”ë§í•˜ëŠ” ë° ì‚¬ìš©í•œë‹¤ë©´ ê·¸ ê°’ì€ ìƒíƒœê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`Tanstack Query` ëŠ” ì´ëŸ° ë°ì´í„°ë“¤ì„ ê´€ë¦¬í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.

ìš°ë¦¬ê°€ í•´ë‹¹ ê°’ë“¤ì„ ë§¤ë²ˆ ì„œë²„ì— íŒ¨ì¹­í•˜ì§€ ì•Šì•„ë„ `staleTime`, `gcTime`
ì„¤ì • ê°’ì— ë”°ë¼ ì¸ë©”ëª¨ë¦¬ì˜ ìºì‹± ê°’ì„ ì°¸ì¡°í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. `REST API` ê°€
ë©±ë“±ì„±ì„ ì§€ë‹ˆê±°ë‚˜ êµ³ì´ ë°ì´í„°ë¥¼ ìì£¼ íŒ¨ì¹­ í•  í•„ìš”ê°€ ì—†ë‹¤ë©´ ì´ëŸ° ìºì‹±
ê°’ì„ ì°¸ì¡°í•˜ëŠ” ê²Œ í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„±ëŠ¥ì— í° ì˜í–¥ì„ ë¼ì¹©ë‹ˆë‹¤.

> ì˜ˆë¥¼ ë“¤ë©´ ì‡¼í•‘ëª°ì˜ ì´ë²¤íŠ¸ ë°°ë„ˆ ì •ë³´ë¥¼ êµ³ì´ ìƒˆë¡œê³ ì¹¨ í•˜ëŠ” ê²Œ ì•„ë‹Œ ì´ìƒ
> ë§¤ë²ˆ ë©”ì¸í™”ë©´ì´ ëœë”ë§ ë  ë•Œë§ˆë‹¤ íŒ¨ì¹­í•˜ëŠ” ê²ƒ ë³´ë‹¤ëŠ” ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
> ì‹œì ì—ì„œ íŒ¨ì¹­ í•œ ê°’ì„ ì“°ëŠ” ê²Œ ì„±ëŠ¥ì— ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.

ë•ë¶„ì— í¸ë¦¬í•˜ê²Œ í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•˜ì§€ë§Œ, ì–´ì¨Œë“  ì¨ë“œíŒŒí‹°
ë¼ì´ë¸ŒëŸ¬ë¦¬ê³  `Tanstack Query` ì— ì˜ì¡´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ê²Œ ë˜ëŠ” ì´ìŠˆê°€
ë°œìƒí•©ë‹ˆë‹¤.

ê³¼ê±°ì— `React Query` ì—ì„œ `Tanstack Query` ë¡œ ë³€ê²½ë˜ëŠ” ê³¼ì •ì—ì„œ, ê·¸ë¦¬ê³ 
ë²„ì „ ì—… ë˜ëŠ” ê³¼ì •ì—ì„œ ìƒë‹¹íˆ ë§ì€ ì½”ë“œë“¤ì„ ìˆ˜ì • í•´ì•¼ í–ˆë˜ ê²½í—˜ì´ ìˆëŠ”
ì €ëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìŠ¤ìŠ¤ë¡œ ì œëŒ€ë¡œ ì•Œê³  ì“°ê³  ìˆëŠ” ì§€ ì˜ë¬¸ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì´ `Tanstack Query` ì˜ êµ¬ì¡°ë¥¼
ì‚´í´ë³´ê³  ë™ì‘ ì›ë¦¬ë¥¼ ì•Œì•„ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

# Tanstack Query ë¼ì´ë¸ŒëŸ¬ë¦¬ êµ¬ì¡°

> tanstack query 5.51.24 ë²„ì „ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„± ë˜ì—ˆìŠµë‹ˆë‹¤.

```bash
yarn add @tanstack/react-query
```

```bash
@tanstack
  â”œâ”€â”€ query-core
  â”‚     â”œâ”€â”€ notifyManager.ts
  â”‚     â”œâ”€â”€ query.ts
  â”‚     â”œâ”€â”€ queryCache.ts
  â”‚     â”œâ”€â”€ queryClient.ts
  â”‚     â””â”€â”€ queryObserver.ts
  â”‚
  â””â”€â”€ react-query
        â”œâ”€â”€ useBaseQuery.ts
        â””â”€â”€ useQuery.ts
```

`Tanstack Query` ë¥¼ ì„¤ì¹˜í•˜ë©´ `query-core` ëª¨ë“ˆì´ ì„¤ì¹˜ ë©ë‹ˆë‹¤.
`react-query` ë¥¼ ì„¤ì¹˜í–ˆë‹¤ë©´ ìœ„ì™€ ê°™ì„ ê²ƒì´ê³  `vue-query` ë¥¼ ì„¤ì¹˜í–ˆë‹¤ë©´
ì½”ì–´ëª¨ë“ˆì€ ê·¸ëŒ€ë¡œì¼í…Œê³  `vue-query` ë””ë ‰í† ë¦¬ê°€ ìƒì„±ëœë‹¤ëŠ” ê²Œ ë‹¤ë¥¸
ì ì…ë‹ˆë‹¤. í•´ë‹¹ ëª¨ë“ˆì€ `vue` ë‚˜ `react` ì—ì„œ ì½”ì–´ëª¨ë“ˆì„ ì‚¬ìš©í•˜ë„ë¡
ë„ì™€ì¤ë‹ˆë‹¤.

## Query Core

ê·¸ëŸ¼ ë¨¼ì € `Query Core` ë¨¼ì € ì‚´í´ë³´ì•„ì•¼ê² ì£ . `Query Core` ì—ì„œ ì¤‘ìš”í•œ
ìš”ì†Œ ë„¤ê°€ì§€ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- QueryClient

- QueryCache

- QueryObserver

- Query

ì´ ê°ì²´ë“¤ì˜ ê´€ê³„ì„±ì„ ì´í•´í•´ ë³´ëŠ” ê²ƒ ë¨¼ì € ì‹œì‘ í•´ ë³´ê² ìŠµë‹ˆë‹¤.

### QueryClient

```typescript
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'

// QueryClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const queryClient = new QueryClient()

function App() {
  return (
    // ë¦¬ì•¡íŠ¸ ì•±ì— ì ìš©ì‹œí‚¤ê¸°
    <QueryClientProvider client={queryClient}>
      <RestOfYourApp />
    </QueryClientProvider>
  )
}
```

`QueryClient` ëŠ” `React context api` ë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì ìœ¼ë¡œ
ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `QueryClientProvider` ì˜ `client` ë¡œ ë„˜ê²¨ì£¼ë©´ í•´ë‹¹
ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì „ì—­ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¡œ ì—¬ëŸ¬ê°œì˜ Providerë¥¼ ë§Œë“¤
ì§€ ì•ŠëŠ”ë‹¤ë©´ 1ê°œë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.

```typescript
export class QueryClient {
  #queryCache: QueryCache
  #mutationCache : MutationCache
  #defaultOptions : DefaultOptions
  #queryDefaults : Map<string, QueryDefaults>
  #mutationDefaults : Map<string, MutationDefaults>
  #mountCount : number
  #unsubscribeFocus?: () => void
  #unsubscribeOnline? : () => void

  constructor(config: QueryClientConfig = {}) {
    this.#queryCache = config.queryCache || new QueryCache()
    //ì´í•˜ ìƒëµ
  }
```

`QueryClient` ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë  ë•Œ `queryCache` ê°’ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.

### QueryCache

```typescript
interface QueryCacheconfig {
    onError?: (
        error: DefaultError,
        query: Query<unknown, unknown, unknown>,
    ) => void
    onSuccess?: (data: unknown, query: QueryQuery<unknown, unknown, unknown>) => void
    onSettled?: (
        data: unknown | undefined,
        error: DefaultError | null,
        query: Query<unknown, unknown, unknown>,
    ) => void
}

export interface QueryStore {
    has: (queryHash: string) => boolean
    set: (queryHash: string, query : Query) => void
    get: (queryHash: string) => Query | undefined
    delete: (queryHash: string) => void
}

// CLASS

export class QueryCache extends Subscribable<QueryCacheListener> {
  #queries: QueryStore

  constructor(public config: QueryCacheConfig = {}) {
    super()
    this.queries = new Map<string, Query>()
  }
  ...
  add(query: Query<any, any, any, any>): void {
    if (!this.#queries.has(query.queryHash)) {
      this.#queries.set(query.queryHash, query)
      this.notify({
        type: 'added',
        query,
      })
    }
  }
  ...
}
```

`QueryCache` ëŠ” `queries` ì¸ìŠ¤í„´ìŠ¤ì— `Query` ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.
ì½”ë“œ ìƒì—ì„œëŠ” ìƒëµ ë˜ì—ˆì§€ë§Œ, `useQuery()` ì˜ ì¸ìë¡œ ë„˜ê²¨ ì¤€ `queryKey`
ë¥¼ ì‚¬ìš©í•´ `queryHash` ë¥¼ ë§Œë“¤ê³  `queries` ì¸ìŠ¤í„´ìŠ¤ì˜ keyë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
ê·¸ë¦¬ê³  valueë¡œ `Query` ê°€ ì €ì¥ë©ë‹ˆë‹¤.

`queries` ëŠ” Map í˜•íƒœë¡œ êµ¬ì„± ë˜ì–´ìˆìŠµë‹ˆë‹¤. Key ê°’ì„ ì•Œê³  ìˆë‹¤ë©´ ì „ë‹¬ë°›ì€
ìš”ì²­ì´ ì´ì „ì— ë“¤ì–´ì˜¨ ìš”ì²­ê³¼ ë™ì¼í•œ ìš”ì²­ì¸ ì§€ íŒë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Query

```typescript
export class Query<

Â  TQueryFnData = unknown,
Â  TError = DefaultError,
Â  TData = TQueryFnData,
Â  TQueryKey extends QueryKey = QueryKey,
> extends Removable {
Â  queryKey: TQueryKey
Â  queryHash: string
Â  options!: QueryOptions<TQueryFnData, TError, TData, TQueryKey>
Â  state: QueryState<TData, TError>
Â  isFetchingOptimistic?: boolean
Â 
Â  #initialState: QueryState<TData, TError>
Â  #revertState?: QueryState<TData, TError>
Â  #cache: QueryCache
Â  #retryer?: Retryer<TData>
Â  observers: Array<QueryObserver<any, any, any, any, any>>
Â  #defaultOptions?: QueryOptions<TQueryFnData, TError, TData, TQueryKey>
Â  #abortSignalConsumed: boolean

Â  constructor(config: QueryConfig<TQueryFnData, TError, TData, TQueryKey>) {

Â  Â  super()
Â  Â  this.observers = []
Â  Â  this.#cache = config.cache
Â  Â  this.queryKey = config.queryKey
Â  Â  this.queryHash = config.queryHash
Â  Â  this.#initialState = getDefaultState(this.options)
Â  Â  this.state = config.state ?? this.#initialState
Â  Â  ...
}
```

`Query` ëŠ” ìì‹ ì„ ê°€ì§€ê³ ìˆëŠ” `QueryCache` ì™€ ìì‹ ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ
í˜¸ì¶œí•  ì˜µì €ë²„ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ë§Œì•½ êµ¬ë… ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ `this.observers`
ì— ì˜µì €ë²„ê°€ ì¶”ê°€ë©ë‹ˆë‹¤. ìƒíƒœê°€ ë³€ê²½ëœë‹¤ë©´ ë“±ë¡ ëœ ì˜µì €ë²„ë“¤ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

`this.state` ì—ëŠ” `data`, `isLoading`, `isFetching` ë“± `useQuery()` ë¥¼
í†µí•´ ì–»ì„ ìˆ˜ ìˆëŠ” ì •ë³´ë“¤ì´ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤.

### QueryObserver

```typescript
export class QueryObserver<
Â  TQueryFnData = unknown,
Â  TError = DefaultError,
Â  TData = TQueryFnData,
Â  TQueryData = TQueryFnData,
Â  TQueryKey extends QueryKey = QueryKey,
> extends Subscribable<QueryObserverListener<TData, TError>> {
Â  Â  super()

Â  Â  this.#client = client
Â  Â  this.#selectError = null
Â  Â  this.bindMethods()
Â  Â  this.setOptions(options)
Â  Â ...
Â  Â Â #trackedProps = new Set<keyof QueryObserverResult>()

Â    protected onSubscribe(): void {
Â  Â    if (this.listeners.size === 1) {
Â  Â  Â    this.#currentQuery.addObserver(this)

Â  Â  Â    if (shouldFetchOnMount(this.#currentQuery, this.options)) {
Â  Â  Â  Â    this.#executeFetch()
Â  Â  Â    } else {
Â  Â  Â  Â    this.updateResult()
Â  Â  Â    }
Â  Â  Â    this.#updateTimers()
Â  Â    }
Â    }

  ...

Â    #updateQuery(): void {
Â  Â    const query = this.#client.getQueryCache().build(this.#client, this.options)

Â  Â    if (query === this.#currentQuery) {
Â  Â  Â    return
Â  Â    }

Â  Â    const prevQuery = this.#currentQuery as
Â  Â  Â    | Query<TQueryFnData, TError, TQueryData, TQueryKey>
Â  Â  Â    | undefined
Â  Â    this.#currentQuery = query
Â  Â    this.#currentQueryInitialState = query.state

Â  Â    if (this.hasListeners()) {
Â  Â  Â    prevQuery?.removeObserver(this)
Â  Â  Â    query.addObserver(this)
Â  Â    }
Â    }
Â  ...

}
```

`QueryObserver` ëŠ” `QueryClient` ì™€ `Query` ë¥¼ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.
`trackedProps` ëŠ” ìš°ë¦¬ê°€ ì–´ë–¤ ìƒíƒœë“¤ì„ ìš”ì²­í–ˆëŠ” ì§€ë¥¼ ê¸°ë¡í•˜ëŠ” ì—­í• ì„
í•©ë‹ˆë‹¤.

êµ¬ë… ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ `Query` ì—ì„œ ì˜µì €ë²„ë¡œ `QueryObserver` ê°€
ë“±ë¡ë©ë‹ˆë‹¤.

### êµ¬ì¡°ë„

![image](https://github.com/user-attachments/assets/60aeb7a9-27b6-413d-abfb-0850bb6a0b9a)

`QueryClient` ë‚´ì— `QueryCache` ê°€ ìƒì„±ë˜ê³ , `QueryCache` ì— ì¡´ì¬í•˜ëŠ”
`QueryStore` ì— `Query` ì •ë³´ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.

ë¬¼ë¡  `Query` ë“¤ ë˜í•œ ìƒì„±ë  ë•Œ ë³¸ì¸ë“¤ì´ ì–´ë–¤ `Store` ì— ì €ì¥ë˜ì–´ìˆëŠ”
ì§€ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.\
ê·¸ë¦¬ê³  `QueryObserver.onSubscribe()` ê°€ í˜¸ì¶œë˜ë©´ `Query` ì˜ `observers`
ì— í•´ë‹¹ `QueryObserver` ê°€ ë“±ë¡ë©ë‹ˆë‹¤.

`QueryObserver` ê°€ ìƒì„±ë  ë•Œ `QueryClient` ì— ë“±ë¡ë˜ê³ , ì´ì „ì— ê°€ì§€ê³ 
ìˆë˜ `Query` ê°€ ì—†ê±°ë‚˜ ìƒˆë¡œ ì—…ë°ì´íŠ¸ ë˜ë©´ `this.query` ë¥¼ ìµœì‹ í™” í•©ë‹ˆë‹¤.

`Query` ì™€ `QueryObserver` ê°„ì— ê´€ê³„ë¥¼ ì‚´í´ë³´ë©´, `useQuery` ì—ì„œ ê°™ì€
Keyë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ë™ì¼í•œ `Query` ë¥¼ ì—¬ëŸ¬ê°œì˜ `QueryObserver` ê°€ ê³µìœ í•˜ê²Œ
ë©ë‹ˆë‹¤. `Query` ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— ê³¼ê±°ì— í•´ë‹¹ Key ê°’ì— ëŒ€í•œ íŒ¨ì¹­ ë¹„ë™ê¸°
í•¨ìˆ˜ë¥¼ ì‹¤í–‰í–ˆì„ ê²½ìš° ì¶”ê°€ì ìœ¼ë¡œ ìš”ì²­í•˜ì§€ ì•Šê³  `Query` ì— ë“±ë¡ë˜ì–´ ìˆë˜
ì˜µì €ë²„ë“¤ì„ í˜¸ì¶œí•˜ì—¬ ë¦¬ëœë”ë§ì„ ì§„í–‰í•©ë‹ˆë‹¤.

### NotifyManager

```typescript
export function createNotifyManager() {

Â  let queue: Array<NotifyCallback> = []
Â  let transactions = 0
Â  let notifyFn: NotifyFunction = (callback) => {
Â  Â  callback()
Â  }
Â  let batchNotifyFn: BatchNotifyFunction = (callback: () => void) => {
Â  Â  callback()
Â  }
Â  let scheduleFn: ScheduleFunction = (cb) => setTimeout(cb, 0)
Â  const setScheduler = (fn: ScheduleFunction) => {
Â  Â  scheduleFn = fn
Â  }

Â  const batch = <T>(callback: () => T): T => {
Â  ...
Â  }

Â  const schedule = (callback: NotifyCallback): void => {
Â  ...
Â  }
Â 
Â Â const batchCalls = <T extends Array<unknown>>(
Â  Â  callback: BatchCallsCallback<T>,
Â  ): BatchCallsCallback<T> => {
Â  ...
Â  }

Â  const flush = (): void => {
Â  ...
Â  }

Â  return {
Â  Â  batch,
Â  Â  batchCalls,
Â  Â  schedule,
Â  Â  ...
Â  } as const

}

// SINGLETON

export const notifyManager = createNotifyManager()
```

:::
:::

`notifyManager` ëŠ” ì‹±ê¸€í†¤ìœ¼ë¡œ ê´€ë¦¬ë˜ë©° í´ë¡œì €ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. `Query`,
`QueryCache`, `QueryObserver` ëŠ” `notifyManager` ë¥¼ ì´ìš©í•´ ìƒíƒœë³€ê²½,
ì˜µì €ë²„ ì¶”ê°€ ë“±ì˜ ì´ë²¤íŠ¸ë¥¼ ì„œë¡œì—ê²Œ ì•Œë ¤ì¤ë‹ˆë‹¤. ë˜í•œ `notifyManager`
ë‚´ë¶€ì—ì„œ ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ì´ ìµœëŒ€í•œ ë™ì‹œì— ì¼ì–´ë‚  ìˆ˜ ìˆë„ë¡ `batch` ê¸°ëŠ¥
ë˜í•œ ì œê³µí•©ë‹ˆë‹¤.

í´ë¡œì €ì— ëŒ€í•´ì„œëŠ” ì¶”í›„ ë‹¤ë¥¸ í¬ìŠ¤íŒ…ì—ì„œ ìì„¸íˆ ì„¤ëª…í•˜ê² ì§€ë§Œ, ì¡°ê¸ˆë§Œ
ì„¤ëª…í•˜ê³  ë„˜ì–´ê°€ìë©´ 1ê¸‰ ê°ì²´ì…ë‹ˆë‹¤. í•¨ìˆ˜ë¥¼ ê°ì²´ë¡œ ì„ ì–¸í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
íŠ¹ì •í•œ í•¨ìˆ˜ë¥¼ ê°ì²´ë¡œ ì§€ì •í•˜ê³  ì´ë¦„ì„ ë¶™í˜ìœ¼ë¡œì„œ `ì–´íœ˜ì  ë²”ìœ„ ì§€ì •`, ì¦‰
ì˜ë¯¸ë¥¼ ê°€ì§€ëŠ” ì¸ìŠ¤í„´ìŠ¤ë¡œì¨ ì„ ì–¸í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

# useQuery Hook ì˜ ì‹¤í–‰ íë¦„

ì§€ê¸ˆê¹Œì§€ Tanstack Query core êµ¬ì¡°ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìœ¼ë‹ˆ ì´ì œ ìœ ì €ê°€
useQuery Hook ì„ ì‹¤í–‰ì‹œì¼°ì„ ë•Œ ì‹¤í–‰ íë¦„ê³¼ React ì»´í¬ë„ŒíŠ¸ì˜ ë¦¬ëœë”ë§
ê³¼ì •ê¹Œì§€ë¥¼ í•œë²ˆ ì‚´í´ ë³´ê² ìŠµë‹ˆë‹¤.

```typescript
import axios from 'axios';
import { useQuery } from '@tanstack/react-query';

const DanalComponent = () => {
  const { isLoading, error, data, isFetching } = useQuery({
    queryKey: ['danalData'],
    queryFn: () =>
      axios
        .get('<https://danal.api.com/api/v1/test>')
        .then((res) => {
          return res.data;
        }),
  });

  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>An error has occurred: + {error.message}</div>;
  return (<div>{JSON.stringify(data)}</div>)
};

export default DanalComponent;
```

```typescript
export function useQuery<
  TQueryFnData,
  TError = DefaultError,
  TData = TQueryFnData,
  TQueryKey extends QueryKey = QueryKey,
>(
  options: UseQueryOptions<TQueryFnData, TError, TData, TQueryFnData, TQueryKey>,
  queryClient?: QueryClient
): UseQueryReturnType<TData, TError> | UseQueryDefinedReturnType<TData, TError> {
  return useBaseQuery(QueryObserver, options, queryClient)
}
```

`useQuery` ë¥¼ í†µí•´ TODO ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. `useQuery` ë¥¼
í˜¸ì¶œí•˜ë©´ ì „ë‹¬ë°›ì€ ì¸ìë“¤ì„ í†µí•´ `useBaseQuery` Hook ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ë•Œ
ì „ë‹¬ ëœ ì˜µì…˜ê³¼ ì •ì˜ ëœ `QueryObserver` í´ë˜ìŠ¤ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.

```typescript
export function useBaseQuery(options, Observer) {
  const queryClient = useQueryClient({ context: options.context })
  const defaultedOptions = queryClient.defaultQueryOptions(options)

  const [observer] = React.useState(() => new Observer(queryClient, defaultedOptions))
  const result = observer.getOptimisticResult(defaultedOptions)

  useSyncExternalStore(
    React.useCallback(
      (onStoreChange) => {
        const unsubscribe = observer.subscribe(notifyManager.batchCalls(onStoreChange))
        // Update result to make sure we did not miss any query updates
        // between creating the observer and subscribing to it.
        observer.updateResult()
        return unsubscribe
      },
      [observer]
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult()
  )
  // Handle result property usage tracking
  return !defaultedOptions.notifyOnChangeProps ? observer.trackResult(result) : result
}
```

`useBaseQuery` ì—ì„œ Provider ë¥¼ í†µí•´ ì „ë‹¬ ë°›ì€ `queryClient` ë¥¼ ê°€ì ¸ì˜¤ê³ 
`QueryObserver` ë¥¼ `useState` ë¥¼ í†µí•´ ìƒì„±í•©ë‹ˆë‹¤. `Query` ì˜ ë³€í™”ë¥¼
ê´€ì°°í•œ `QueryObserver` ëŠ” ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¦¬ëœë”ë§ ì‹œí‚¤ê¸° ìœ„í•´ì„œ
`useSyncExternalStore` í›…ì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° ì½œë°± íŒŒë¼ë¯¸í„°ë¡œ
`onStoreChange`, ì¦‰ í›…ì„ í˜¸ì¶œí•˜ëŠ” ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•´ ë¦¬ëœë”ë§ì„
ì§€ì‹œí•˜ëŠ” í•¨ìˆ˜ë¥¼ ì „ë‹¬ ë°›ìŠµë‹ˆë‹¤.

```typescript
export class Subscribable<TListener extends Function> {
  protected listeners = new Set<TListener>()

  constructor() {
    this.subscribe = this.subscribe.bind(this)
  }

  subscribe(listener: TListener): () => void {
    this.listeners.add(listener)
    this.onSubscribe()

    return () => {
      this.listeners.delete(listener)
      this.onUnsubscribe()
    }
  }

  hasListeners(): boolean {
    return this.listeners.size > 0
  }

  protected onSubscribe(): void {
    // Do nothing
  }

  protected onUnsubscribe(): void {
    // Do nothing
  }
}
```

`onStoreChange` ëŠ” `observer.subscribe(onStoreChange)` ë¥¼ ë”°ë¼
ì´ë™í•©ë‹ˆë‹¤. `onStoreChange` ëŠ” `listeners` ì— ë“±ë¡ë©ë‹ˆë‹¤.

```typescript
export class QueriesObserver<
Â  TCombinedResult = Array<QueryObserverResult>,
> extends Subscribable<QueriesObserverListener> {

  constructor() {}
  ...
Â  #notify(): void {
Â  Â  notifyManager.batch(() => {
Â  Â  Â  this.listeners.forEach((listener) => {
Â  Â  Â  Â  listener(this.#result)
Â  Â  Â  })
Â  Â  })
Â  }
}
```

`notify` ë©”ì†Œë“œëŠ” ë“±ë¡ ëœ `listeners` ë¥¼ ìˆœíšŒí•˜ë©° `listener` í•¨ìˆ˜ë¥¼ ì‹¤í–‰
ì‹œí‚µë‹ˆë‹¤.

ì´ ê³¼ì •ì—ì„œ `QueryObserver` ì¸ìŠ¤í„´ìŠ¤ì™€ ì—°ê²° ëœ ì»´í¬ë„ŒíŠ¸ë“¤ì— ëŒ€í•´
ë¦¬ëœë”ë§ì„ ì§€ì‹œí•©ë‹ˆë‹¤. ê·¸ ê²°ê³¼ ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ ë˜ë©° `Query` ì˜ ë³€ê²½
ëœ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.

ì •ë¦¬ í•´ ë³´ë©´, `useQuery` í›…ì„ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ `Query` ì˜ ë³€í™”ë¥¼ ê´€ì°°í•˜ëŠ”
`QueryObserver` ê°€ ìƒì„±ë˜ì–´ ì»´í¬ë„ŒíŠ¸ì™€ ì—°ê²°ë©ë‹ˆë‹¤. `Query` ì˜ ë³€í™”ì—
ë”°ë¼ ì»´í¬ë„ŒíŠ¸ì˜ ë¦¬ë Œë”ë§ì´ ë°œìƒí•˜ë©° ë³€ê²½ ëœ ë°ì´í„°ê°€ ë°˜ì˜ ë©ë‹ˆë‹¤.

# Outro

ì§€ê¸ˆê¹Œì§€ `Tanstack Query` ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ êµ¬ì¡°, ê·¸ë¦¬ê³  `useQuery` Hook API
ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ ì»´í¬ë„ŒíŠ¸ì— ë°ì´í„°ê°€ ë°˜ì˜ë˜ëŠ” ê³¼ì •ì— ëŒ€í•´ ì•Œì•„ ë³´ì•˜ìŠµë‹ˆë‹¤.

ì²˜ìŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë„ì…í–ˆì„ ë•Œ ë™ì‘ ì›ë¦¬ë¥¼ ì˜ ëª°ë¼ì„œ ì‚¬ìš©í•˜ëŠ” ë° ì• ë¥¼
ë¨¹ì—ˆë˜ ê¸°ì–µì´ ë‚¬ìŠµë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë„ì…í•˜ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ, ë‚´ë¶€
êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ê³  ì›ë¦¬ë¥¼ ì´í•´í•œë‹¤ë©´ ê²°ê³¼ë¬¼ì˜ ìœ ì§€ë³´ìˆ˜ì„±ì— í° ë„ì›€ì´ ë˜ì§€
ì•Šì„ê¹Œìš”? ğŸ˜Š

# Reference

[https://fe-developers.kakaoent.com/2023/230720-react-query/](https://fe-developers.kakaoent.com/2023/230720-react-query/)
[https://www.timegambit.com/blog/digging/react-query/01](https://www.timegambit.com/blog/digging/react-query/01)
[https://www.timegambit.com/blog/digging/react-query/02](https://www.timegambit.com/blog/digging/react-query/02)
[https://tkdodo.eu/blog/inside-react-query](https://tkdodo.eu/blog/inside-react-query)
[https://react.dev/reference/react/useSyncExternalStore](https://react.dev/reference/react/useSyncExternalStore)
